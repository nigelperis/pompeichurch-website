---
import Layout from "~/layouts/layout.astro";
import { getLangFromUrl, useTranslations } from "~/i18n/utils";
import { listObituaries } from "~/services/obituaries/list-obituaries";
import { Locale } from "~/enums/locale";
import ObituaryCard from "~/components/ObituaryCard.tsx";
import { cn } from "~/helpers/cn";
import { getPlaceholderImage } from "~/helpers/get-placeholder-image";

const { slug } = Astro.params; // Get the slug from the URL
const lang = getLangFromUrl(Astro.url) as Locale;
const t = useTranslations(lang);

const { obituaries } = await listObituaries({ pageSize: 1000 });
const selectedObituary = obituaries.find((item) => item.slug === slug);

if (!selectedObituary) {
  return Astro.redirect("/404", 302);
}

const baseURL = import.meta.env.PUBLIC_STRAPI_URL;
const absoluteImage = selectedObituary.image?.formats?.medium?.url
  ? new URL(selectedObituary.image.formats.medium.url, baseURL).toString()
  : selectedObituary.image?.url
    ? new URL(selectedObituary.image.url, baseURL).toString()
    : getPlaceholderImage({
        text: selectedObituary.englishName,
        width: 340,
        height: 400,
      });

const obituaryImage = selectedObituary.image?.url
  ? new URL(selectedObituary.image.url, baseURL).toString()
  : getPlaceholderImage({
      text: selectedObituary.englishName,
      width: 340,
      height: 400,
    });

const obituaryUrl = new URL(
  lang === Locale.EN ? `/obituary/${slug}` : `/kok/obituary/${slug}`,
  Astro.url,
).href;

const pageTitle = selectedObituary
  ? lang === Locale.EN
    ? `${selectedObituary.englishName}`
    : `${selectedObituary.konkaniName}`
  : "Obituary";
---

<Layout
  title={`${pageTitle} ${selectedObituary?.age ? `(${selectedObituary.age})` : ""}`}
  description={selectedObituary?.ward
  ? `${selectedObituary.ward} ${t("ward")}`
  : "Pompei Church Obituaries"}
  image={absoluteImage}
  url={obituaryUrl}
>
  <main class="mx-auto max-w-screen-lg overflow-hidden bg-white p-6">
    <section class="flex flex-col pb-4">
      <div
        class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mb-4"
      >
        <h1
          class={cn(
            "font-black border-natgeo-yellow mb-2 md:mb-0 border-l-4 pl-3 text-3xl lg:text-4xl",
            { "pt-2 font-bold": lang === Locale.KOK },
          )}
        >
          {t("nav.obituary")}
        </h1>
      </div>

      <p
        class={cn("p-3 pb-6 text-2xl font-bold italic text-red-600", {
          "font-semibold": lang === Locale.KOK,
        })}
      >
        {t("obituary.subtitle")}
      </p>

      <ObituaryCard
        client:load
        id={selectedObituary.id}
        name={lang === Locale.EN
          ? selectedObituary.englishName
          : selectedObituary.konkaniName}
        age={selectedObituary.age}
        relationType={selectedObituary.relationType}
        relationNameEn={selectedObituary.relationNameEn}
        relationNameKok={selectedObituary.relationNameKok}
        ward={selectedObituary.ward}
        dateOfDeath={selectedObituary.dateOfDeath
          ? new Date(selectedObituary.dateOfDeath).toISOString()
          : ""}
        imageWidth={340}
        imageHeight={400}
        imageUrl={obituaryImage}
        slug={selectedObituary.slug}
        funeralDetails={selectedObituary.funeralDetails}
        funeralDetailsKok={selectedObituary.funeralDetailsKok}
        funeralDetailsUpdatedAt={selectedObituary.funeralDetailsUpdatedAt}
        youtubeLink={selectedObituary.youtubeLink}
        className="mx-auto"
        autoFlip={true}
      />
    </section>
  </main>
</Layout>
