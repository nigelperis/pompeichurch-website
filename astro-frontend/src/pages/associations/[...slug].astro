---
import Layout from "~/layouts/layout.astro";
import { getLangFromUrl, useTranslations } from "~/i18n/utils";
import AssociationDetails from "~/components/sections/associations/association-details.astro";
import { listAssociations } from "~/services/associations/list-associations";
import { getAssociation } from "~/services/associations/get-association";
import { Locale } from "~/enums/locale";
import type { Association } from "~/models/association";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

export async function getStaticPaths() {
  const assocs = await listAssociations();
  return assocs.map(({ slug }) => ({ params: { slug } }));
}

const { slug } = Astro.params as { slug: string };

const [assocPrimary, assocFallback] = await Promise.all([
  getAssociation({ slug, locale: lang as Locale }),
  getAssociation({ slug, locale: Locale.EN }),
]);

const association: Association | null = assocPrimary || assocFallback;

if (!association) {
  return Astro.redirect("/404", 302);
}

const ogImage = association.groupImage?.url
  ? new URL(association.groupImage.url, import.meta.env.PUBLIC_STRAPI_URL).toString()
  : undefined;
const konkaniDescription = association?.shortDescription ?? "";
const englishDescription = association?.shortDescription ?? "";

function stripHtmlTags(html: string): string {
  return html
    .replace(/<[^>]+>/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

const plainKok = Array.isArray(konkaniDescription)
  ? stripHtmlTags(konkaniDescription.join(" "))
  : stripHtmlTags(konkaniDescription);

const plainEn = Array.isArray(englishDescription)
  ? stripHtmlTags(englishDescription.join(" "))
  : stripHtmlTags(englishDescription);

const ogDescription =
  lang === Locale.KOK
    ? plainKok?.substring(0, 300) || plainEn?.substring(0, 300)
    : plainEn?.substring(0, 300) || plainKok?.substring(0, 300);

const ogTitle = association.name;

const ogImageUrl = ogImage;
---

<Layout title={ogTitle} description={ogDescription} image={ogImageUrl}>
  <main class="mx-auto max-w-screen-lg overflow-hidden bg-white">
    <section id="associations" class="flex flex-col p-6 pb-4">
      <h1
        class="font-black border-natgeo-yellow mb-5 border-l-4 pl-3 text-3xl lg:text-4xl"
      >
        {ogTitle}
      </h1>
      <AssociationDetails />
    </section>
  </main>
</Layout>
