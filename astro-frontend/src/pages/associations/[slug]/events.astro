---
import Layout from "~/layouts/layout.astro";
import { getLangFromUrl, useTranslations } from "~/i18n/utils";
import { getAssociation } from "~/services/associations/get-association";
import { listAssociations } from "~/services/associations/list-associations";
import { listEvents } from "~/services/events/list-events";
import EventsList from "~/components/sections/events/events-list.astro";
import { Locale } from "~/enums/locale";
import { cn } from "~/helpers/cn";
import { Message } from "~/constants/message.ts";
import PushNotification from "~/components/push-notification.astro";
import Pagination from "~/components/pagination.astro";
import { getPaginationRange } from "~/helpers/get-pagination-range";
import { ITEMS_PER_PAGE } from "~/constants/index.ts";
import SelectAssociationRedirect from "~/components/ui/SelectAssociationRedirect";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const { slug } = Astro.params as { slug: string };

const [assocPrimary, assocFallback] = await Promise.all([
  getAssociation({ slug, locale: lang as Locale }),
  getAssociation({ slug, locale: Locale.EN }),
]);

const association = assocPrimary || assocFallback;
const title = association?.name ?? slug;

const currentPage = Number(Astro.url.searchParams.get("p")) || 1;

const { events: filteredEvents } = await listEvents({
  page: 1,
  pageSize: 500, //Todo Comment
  filters: { "association.slug": { $eq: slug } },
});

const totalEvents = filteredEvents.length;
const totalPages = Math.ceil(totalEvents / ITEMS_PER_PAGE);

const paginatedEvents = filteredEvents.slice(
  (currentPage - 1) * ITEMS_PER_PAGE,
  currentPage * ITEMS_PER_PAGE,
);

const pageTitle = `${title} Events | Pompei Church`;

const associations = await listAssociations({ locale: lang as Locale });
---

<Layout title={pageTitle}>
  <main class="mx-auto max-w-screen-lg overflow-hidden bg-white">
    <section id="events" class="flex flex-col p-6">
      <PushNotification />

      <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mb-4">
        <h1
          class={cn(
            "font-black border-natgeo-yellow mb-2 md:mb-0 border-l-4 pl-3 text-3xl lg:text-4xl",
            { "font-bold": lang === Locale.KOK },
          )}
        >
          {t("nav.events")} - {title}
        </h1>

        {associations.length > 0 && (
          <div class="w-full md:w-64">
            <SelectAssociationRedirect
              client:load
              associations={associations}
              placeholder={title}
              allLabel={t("all")}
            />
          </div>
        )}
      </div>

      {
        paginatedEvents.length > 0 ? (
          <>
            <EventsList events={paginatedEvents} />
            <Pagination
              currentPage={currentPage}
              totalPages={totalPages}
              getPaginationRange={getPaginationRange}
            />
          </>
        ) : (
          <p class="py-8 text-center text-3xl font-semibold">
            {Message.EVENTS_NOT_FOUND}
          </p>
        )
      }
    </section>
  </main>
</Layout>
