---
import { cn } from "~/helpers/cn";
import NetworkImage from "./ui/network-image.astro";
import ShareLink from "./ui/share-link.astro";
import { getLangFromUrl } from "~/i18n/utils";
import { Locale } from "~/enums/locale";

interface Props {
  id: string;
  name: string;
  imageUrl: string;
  imageWidth: number;
  imageHeight: number;
  age: string | number;
  gender: string;
  spouseName?: string;
  ward: string;
  dateOfDeath: string;
  class?: string;
}

const {
  id,
  name,
  age,
  gender,
  spouseName,
  ward,
  dateOfDeath,
  imageWidth,
  imageHeight,
  class: className,
  imageUrl,
  ...rest
} = Astro.props;

const lang = getLangFromUrl(Astro.url);

const labels = {
  [Locale.EN]: {
    spouse: gender === 'Male' ? 'Wife' : gender === 'Female' ? 'Husband' : 'Spouse',
    age: "Age",
    ward: "Ward",
    death: "Date of Death",
  },
  [Locale.KOK]: {
    spouse: gender === 'Male' ? 'ಪತಿಣ್' : gender === 'Female' ? 'ಪತಿ' : 'ಸಾತೀ',
    age: "ಪ್ರಾಯ್",
    ward: "ವಾಡೊ",
    death: "ಮರಣ್",
  }
};
const activeLabels = labels[lang] ?? labels[Locale.EN];

const wardMap: Record<string, { en: string; kok: string }> = {
  "Kowdoor A": { en: "Kowdoor A", kok: "ಕೌಡೂರ್ ಎ" },
  "Kowdoor B": { en: "Kowdoor B", kok: "ಕೌಡೂರ್ ಬಿ" },
  "Pompei A": { en: "Pompei A", kok: "ಪೊಂಪೈ ಎ" },
  "Pompei B": { en: "Pompei B", kok: "ಪೊಂಪೈ ಬಿ" },
  "Kandar A": { en: "Kandar A", kok: "ಕಂದಾರ್ ಎ" },
  "Kandar B": { en: "Kandar B", kok: "ಕಂದಾರ್ ಬಿ" },
  "Monel": { en: "Monel", kok: "ಮಣೆಲ್" },
  "Gurpur": { en: "Gurpur", kok: "ಗುರ್ಪುರ್" },
  "Church": { en: "Church", kok: "ಇಗರ್ಜೆ" },
  "Addoor": { en: "Addoor", kok: "ಅಡ್ಡೂರ್" },
};

const localizedWard = wardMap[ward]?.[lang === "kok" ? "kok" : "en"] ?? ward;

const obituaryUrl = new URL(
  lang === Locale.EN
    ? `/obituary?id=${id.replace(/\s+/g, "-").toLowerCase()}`
    : `/kok/obituary?id=${id.replace(/\s+/g, "-").toLowerCase()}`,
  Astro.url
).href;
---

<div
  id={id.replace(/\s+/g, "-").toLowerCase()}
  class={cn(
    "hover:scale-[1.01] transition-transform duration-500 ease-in-out border border-gray-200 rounded-lg overflow-hidden w-full max-w-sm sm:max-w-[90%] md:max-w-[85%] lg:max-w-[440px] mx-auto relative bg-white",
    className
  )}
style={{ minHeight: "100%" }}

>
  <div class="w-full aspect-[2/3] sm:aspect-[2.3/3] bg-gray-100">
    <NetworkImage
      src={imageUrl}
      alt={`Image of ${name}`}
      width={imageWidth}
      height={imageHeight}
      class="w-full h-full object-cover"
    />
  </div>

  <div class="p-4 space-y-1 font-noto-sans-kannada">
    <h3 class="text-lg sm:text-xl font-semibold text-slate-900 truncate" title={name}>
      {name}
    </h3>

    {spouseName && (
      <p class="text-sm sm:text-base text-slate-700">
        <strong>{activeLabels.spouse}:</strong> {spouseName}
      </p>
    )}

    {age && (
      <p class="text-sm sm:text-base text-slate-700">
        <strong>{activeLabels.age}:</strong> {age}
      </p>
    )}

    {ward && (
      <p class="text-sm sm:text-base text-slate-700">
        <strong>{activeLabels.ward}:</strong> {localizedWard}
      </p>
    )}

    {dateOfDeath && (
      <p class="text-sm sm:text-base text-slate-700">
        <strong>{activeLabels.death}:</strong> {dateOfDeath}
      </p>
    )}
  </div>

  <ShareLink
    class="absolute top-3 right-3 bg-white p-2 rounded-full shadow-md"
    shareData={{
      url: obituaryUrl,
      title: `${name} - ${ward}`,
    }}
  />
</div>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const obituaryId = params.get("id");

    if (obituaryId) {
      const targetElement = document.getElementById(obituaryId);

      if (targetElement) {
        setTimeout(() => {
          targetElement.scrollIntoView({ behavior: "smooth", block: "start" });
        }, 300);
      }
    }
  });
</script>
