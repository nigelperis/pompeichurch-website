---
import { getLangFromUrl, useTranslations } from "~/i18n/utils";
import { cn } from "~/helpers/cn";
import HoverableLink from "~/components/ui/hoverable-link.astro";
import ObituaryCard from "~/components/ObituaryCard.tsx";
import { getPlaceholderImage } from "~/helpers/get-placeholder-image";
import { listObituaries } from "~/services/obituaries/list-obituaries";
import { Message } from "~/constants/message.ts";
import { Locale } from "~/enums/locale";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const obituaryLink = lang === Locale.EN ? "/obituary" : "/kok/obituary";

const { obituaries } = await listObituaries({ page: 1, pageSize: 5 });

const obituaryDataFormatted = obituaries.map((obituary) => ({
  ...obituary,
  dateOfDeath: obituary.dateOfDeath
    ? new Date(obituary.dateOfDeath).toISOString()
    : "",
  slug:
    obituary.slug ??
    `${(obituary.englishName ?? "").replace(/\s+/g, "-").toLowerCase()}-${obituary.id}`,
}));
---

<section
  id="obituary-section"
  class="mt-1 flex flex-col py-8 lg:mx-28 lg:py-12"
>
  <h1
    class={cn(
      "font-black mx-6 mb-6 inline-block border-l-4 border-natgeo-yellow pl-3 text-2xl lg:mx-0 lg:mb-8 lg:text-4xl",
      { "font-extrabold pt-2": lang === Locale.KOK },
    )}
  >
    {t("nav.obituary")}
  </h1>

  {
    obituaryDataFormatted.length > 0 ? (
      <div class="w-full">
        {/* Mobile: Horizontal scroll */}
        <div class="flex gap-4 overflow-x-auto px-6 pb-8 lg:hidden snap-x snap-mandatory items-start">
          {obituaryDataFormatted.slice(0, 4).map((o, index) => (
            <div class="flex-shrink-0 w-[280px] snap-center">
              <ObituaryCard
                client:load
                id={o.id}
                name={lang === "kok" ? o.konkaniName : o.englishName}
                imageUrl={
                  o.image?.url
                    ? new URL(
                        o.image.url,
                        import.meta.env.PUBLIC_STRAPI_URL,
                      ).toString()
                    : getPlaceholderImage({
                        text: o.englishName,
                        width: 280,
                        height: 350,
                      })
                }
                imageWidth={280}
                imageHeight={350}
                dateOfDeath={o.dateOfDeath}
                age={o.age}
                relationType={o.relationType}
                relationNameEn={o.relationNameEn}
                relationNameKok={o.relationNameKok}
                ward={o.ward}
                slug={o.slug}
                youtubeLink={o.youtubeLink}
                homeTime={o.homeTime}
                massTime={o.massTime}
                funeralDate={o.funeralDate}
                startsFromChurch={o.startsFromChurch}
                funeralDetailsUpdatedOn={o.funeralDetailsUpdatedOn}
                autoFlip={true}
                locale={lang}
              />
            </div>
          ))}
        </div>

        {/* Desktop: Grid layout */}
        <div class="hidden lg:flex flex-wrap justify-center gap-8 px-6 pb-8">
          {obituaryDataFormatted.slice(0, 4).map((o) => (
            <div class="flex-none">
              <ObituaryCard
                client:load
                id={o.id}
                name={lang === "kok" ? o.konkaniName : o.englishName}
                imageUrl={
                  o.image?.url
                    ? new URL(
                        o.image.url,
                        import.meta.env.PUBLIC_STRAPI_URL,
                      ).toString()
                    : getPlaceholderImage({
                        text: o.englishName,
                        width: 340,
                        height: 400,
                      })
                }
                imageWidth={340}
                imageHeight={400}
                dateOfDeath={o.dateOfDeath}
                age={o.age}
                relationType={o.relationType}
                relationNameEn={o.relationNameEn}
                relationNameKok={o.relationNameKok}
                ward={o.ward}
                slug={o.slug}
                youtubeLink={o.youtubeLink}
                homeTime={o.homeTime}
                massTime={o.massTime}
                funeralDate={o.funeralDate}
                startsFromChurch={o.startsFromChurch}
                funeralDetailsUpdatedOn={o.funeralDetailsUpdatedOn}
                autoFlip={true}
                locale={lang}
              />
            </div>
          ))}
        </div>

        {/* View All button */}
        <div class="flex justify-center px-6">
          <HoverableLink href={obituaryLink}>{t("ui.view-all")}</HoverableLink>
        </div>
      </div>
    ) : (
      <p class="py-8 text-center text-3xl font-semibold">
        {Message.OBITUARIES_NOT_FOUND}
      </p>
    )
  }
</section>
